{% extends "base.html" %}

{% block title %}Login{% endblock %}

{% block content %}
<div class="w-full max-w-md mx-auto">
    <!-- Header -->
    <div class="text-center mb-40">
       
    </div>

    <!-- Login Options -->
    <div class="mt-8 grid grid-cols-1 gap-4 sm:grid-cols-2">
        <!-- Admin Login Button -->
        <button onclick="showAdmin()" 
                id="admin-btn"
                class="group relative w-full flex justify-center py-4 px-4 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg">
            <span class="flex items-center">
                <i class="fas fa-user-shield mr-2"></i>
                Login Admin
            </span>
        </button>

        <!-- Store/Siswa Login Button -->
        <button onclick="showSiswa()" 
                id="siswa-btn"
                class="group relative w-full flex justify-center py-4 px-4 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg">
            <span class="flex items-center">
                <i class="fas fa-user mr-2"></i>
                Login Pemilih
            </span>
        </button>
    </div>

    <!-- Admin Login Form -->
    <div id="admin-form" class="hidden mt-8 bg-white p-8 rounded-2xl shadow-lg border border-gray-200 card-hover">
        <div class="text-center mb-6">
            <h3 class="text-2xl font-bold text-gray-900">Login Admin</h3>
            <p class="text-gray-600 mt-2">Masukkan kredensial admin Anda</p>
        </div>
        
        <form method="POST" action="{{ url_for('login') }}" class="space-y-6" id="admin-login-form">
            <input type="hidden" name="login_type" value="admin">
            
            <div>
                <label for="username" class="sr-only">Username</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-user text-gray-400"></i>
                    </div>
                    <input id="username" name="username" type="text" autocomplete="username" required 
                           class="relative block w-full pl-10 pr-3 py-4 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300"
                           placeholder="Username"
                           value="{{ request.form.username if request.method == 'POST' and request.form.login_type == 'admin' }}">
                </div>
            </div>

            <div>
                <label for="password" class="sr-only">Password</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-lock text-gray-400"></i>
                    </div>
                    <input id="password" name="password" type="password" autocomplete="current-password" required 
                           class="relative block w-full pl-10 pr-3 py-4 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300"
                           placeholder="Password">
                </div>
            </div>

            <!-- Error Message -->
            <div id="admin-error" class="hidden bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
                    <span class="text-red-700 text-sm font-medium" id="admin-error-text"></span>
                </div>
            </div>

            <div>
                <button type="submit" 
                        id="admin-submit-btn"
                        class="group relative w-full flex justify-center py-4 px-4 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 transform hover:-translate-y-0.5 hover:shadow-lg">
                    <span class="flex items-center">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        Login Admin
                    </span>
                </button>
            </div>
        </form>
    </div>

    <!-- Siswa/Store Login Form -->
    <div id="siswa-form" class="hidden mt-8 bg-white p-8 rounded-2xl shadow-lg border border-gray-200 card-hover">
        <div class="text-center mb-6">
            <h3 class="text-2xl font-bold text-gray-900">Login Pemilih</h3>
            <p class="text-gray-600 mt-2">Masukkan Nomor WhatsApp Untuk Mendapatkan Kode Voting</p>
        </div>
        
        <form id="waForm" class="space-y-6">
            <input type="hidden" name="login_type" value="siswa">
            
            <div>
                <label for="no_wa" class="block text-sm font-medium text-gray-700 mb-2">
                    Nomor WhatsApp
                </label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-phone text-gray-400"></i>
                    </div>
                    <input type="text" id="no_wa" name="no_wa" placeholder="081234567890" required
                           class="relative block w-full pl-10 pr-3 py-4 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-300">
                </div>
                <p class="mt-2 text-xs text-gray-500">Contoh: 081234567890 (tanpa +62)</p>
            </div>

            <div>
                <button type="submit" 
                        class="group relative w-full flex justify-center py-4 px-4 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-300 transform hover:-translate-y-0.5 hover:shadow-lg"
                        id="submitBtn">
                    <span class="flex items-center">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Minta Kode Voting
                    </span>
                </button>
            </div>
        </form>
        
        <!-- Loading State -->
        <div id="loading" class="hidden mt-6 p-4 bg-green-50 rounded-xl border border-green-200">
            <div class="flex items-center justify-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
                <p class="text-green-700 font-medium">Mengirim kode ke WhatsApp...</p>
            </div>
        </div>
    </div>
</div>

<script>
// Toggle between login forms
function showAdmin() {
    document.getElementById('admin-form').classList.remove('hidden');
    document.getElementById('siswa-form').classList.add('hidden');
    
    // Add active state to buttons
    document.querySelectorAll('button[onclick]').forEach(btn => {
        if (btn.textContent.includes('Admin')) {
            btn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
        } else {
            btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
        }
    });
}

function showSiswa() {
    document.getElementById('admin-form').classList.add('hidden');
    document.getElementById('siswa-form').classList.remove('hidden');
    
    // Add active state to buttons
    document.querySelectorAll('button[onclick]').forEach(btn => {
        if (btn.textContent.includes('Pemilih')) {
            btn.classList.add('ring-2', 'ring-offset-2', 'ring-green-500');
        } else {
            btn.classList.remove('ring-2', 'ring-offset-2', 'ring-green-500');
        }
    });
}

// Handle Admin form submission with visual feedback
document.getElementById('admin-login-form').addEventListener('submit', function(event) {
    const submitBtn = document.getElementById('admin-submit-btn');
    const errorDiv = document.getElementById('admin-error');
    const errorText = document.getElementById('admin-error-text');
    
    // Reset previous error states
    errorDiv.classList.add('hidden');
    submitBtn.classList.remove('bg-gradient-to-r', 'from-red-500', 'to-red-600', 'hover:from-red-600', 'hover:to-red-700');
    submitBtn.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'hover:from-blue-600', 'hover:to-blue-700');
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>Memproses...';
});

// Handle WhatsApp form submission
document.getElementById('waForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    
    const noWa = document.getElementById('no_wa').value.trim();
    const submitBtn = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    
    if (!noWa) {
        alert('Nomor WhatsApp harus diisi');
        return;
    }
    
    // Validasi format nomor
    if (!/^[0-9]{10,13}$/.test(noWa)) {
        alert('Format nomor WhatsApp tidak valid. Contoh: 081234567890');
        return;
    }
    
    // Tampilkan loading
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>Mengirim...';
    loading.classList.remove('hidden');
    
    try {
        const response = await fetch('/request-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ no_wa: noWa })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Kode telah dikirim ke WhatsApp Anda!');
            // Redirect ke halaman verifikasi kode
            window.location.href = "{{ url_for('verify_code') }}";
        } else {
            alert(data.message || 'Gagal mengirim kode. Silakan coba lagi.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Terjadi kesalahan. Silakan coba lagi.');
    } finally {
        // Reset button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Minta Kode Voting';
        loading.classList.add('hidden');
    }
});

// Check for login errors on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check if there was a failed admin login attempt
    const urlParams = new URLSearchParams(window.location.search);
    const loginError = urlParams.get('login_error');
    
    if (loginError === 'admin') {
        showAdmin();
        
        // Show error state
        const submitBtn = document.getElementById('admin-submit-btn');
        const errorDiv = document.getElementById('admin-error');
        const errorText = document.getElementById('admin-error-text');
        
        // Change button to red
        submitBtn.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'hover:from-blue-600', 'hover:to-blue-700');
        submitBtn.classList.add('bg-gradient-to-r', 'from-red-500', 'to-red-600', 'hover:from-red-600', 'hover:to-red-700');
        
        // Show error message
        errorText.textContent = 'Username atau password salah!';
        errorDiv.classList.remove('hidden');
        
        // Add shake animation to form
        const adminForm = document.getElementById('admin-form');
        adminForm.classList.add('animate-shake');
        
        // Remove animation after it completes
        setTimeout(() => {
            adminForm.classList.remove('animate-shake');
        }, 500);
        
        // Auto-clear error after 3 seconds
        setTimeout(() => {
            errorDiv.classList.add('hidden');
            submitBtn.classList.remove('bg-gradient-to-r', 'from-red-500', 'to-red-600', 'hover:from-red-600', 'hover:to-red-700');
            submitBtn.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'hover:from-blue-600', 'hover:to-blue-700');
        }, 3000);
    } else {
        // Default show admin form
        showAdmin();
    }
});

// Add shake animation CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    .animate-shake {
        animation: shake 0.5s ease-in-out;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}