{% extends "base.html" %}

{% block title %}Verifikasi Kode{% endblock %}

{% block content %}
<div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 max-w-md mx-auto card-hover">
    <!-- Header -->
    <div class="text-center mb-8">
        <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-full p-4 inline-flex items-center justify-center mb-4 shadow-md">
            <i class="fas fa-shield-alt text-blue-500 text-2xl"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Verifikasi Kode Voting</h2>
        <p class="text-gray-600">Masukkan kode 6 digit yang dikirim ke WhatsApp Anda</p>
        
        <!-- Progress Indicator -->
        <div class="mt-6 bg-gray-100 rounded-full h-3 w-full shadow-inner">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-500" style="width: 80%"></div>
        </div>
        <p class="text-sm text-gray-500 mt-2">Langkah 3 dari 3: Verifikasi Kode</p>
    </div>
    
    <!-- Debug Info (disederhanakan) -->
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg mb-6">
        <div class="flex items-start">
            <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-3"></i>
            <div class="flex-1">
                <h4 class="font-semibold text-blue-800 text-sm mb-1">Informasi Verifikasi</h4>
                <div class="text-xs text-blue-700 space-y-1">
                    <p><strong>Nomor WA:</strong> <span id="debug-wa" class="font-medium">{{ session.get('pending_wa', 'Tidak ada') }}</span></p>
                    <p><strong>Status:</strong> 
                        <span id="debug-session" class="{% if session.get('pending_wa') %}text-green-600 font-medium{% else %}text-red-600{% endif %}">
                            {% if session.get('pending_wa') %}Aktif{% else %}Tidak aktif{% endif %}
                        </span>
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <form method="POST" class="space-y-6" id="verifyForm">
        <!-- Digit Inputs -->
        <div class="mb-8">
            <label for="kode" class="block text-sm font-medium text-gray-700 mb-4 text-center">Kode 6 Digit</label>
            
            <div class="flex justify-center space-x-2 md:space-x-3 mb-4" id="digit-inputs">
                {% for i in range(6) %}
                <input type="text" 
                       id="digit{{i}}" 
                       maxlength="1" 
                       pattern="[0-9]" 
                       class="digit-input w-12 h-12 md:w-14 md:h-14 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all duration-200 shadow-sm"
                       data-index="{{i}}"
                       autocomplete="off">
                {% endfor %}
            </div>
            
            <!-- Hidden input for form submission -->
            <input type="hidden" id="kode" name="kode" required>
            
            <p class="text-xs text-gray-500 text-center mt-4">
                <i class="fas fa-mobile-alt mr-1"></i>
                Kode telah dikirim ke WhatsApp Anda
            </p>
        </div>
        
        <!-- Action Buttons -->
        <div class="space-y-4">
            <button type="submit" 
                    id="submitBtn"
                    class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-3 px-4 rounded-lg font-medium transition-all duration-300 transform hover:-translate-y-0.5 hover:shadow-lg flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none">
                <i class="fas fa-check-circle mr-2"></i>
                Verifikasi & Lanjut Voting
            </button>
            
            <div class="text-center">
                <a href="{{ url_for('login') }}" class="text-blue-500 hover:text-blue-700 font-medium inline-flex items-center text-sm transition-colors duration-300">
                    <i class="fas fa-arrow-left mr-2"></i>Kembali ke Login
                </a>
            </div>
        </div>
    </form>
    
    <!-- Resend Code Option -->
    <div class="mt-8 pt-6 border-t border-gray-100 text-center">
        <p class="text-sm text-gray-600 mb-2">Tidak menerima kode?</p>
        <button id="resendBtn" class="text-blue-500 hover:text-blue-700 font-medium text-sm inline-flex items-center transition-colors duration-200">
            <i class="fas fa-redo-alt mr-2"></i>
            <span id="resendText">Kirim Ulang Kode</span>
            <span id="countdown" class="hidden ml-1 text-orange-500"></span>
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const digitInputs = document.querySelectorAll('.digit-input');
    const hiddenInput = document.getElementById('kode');
    const form = document.getElementById('verifyForm');
    const submitBtn = document.getElementById('submitBtn');
    const resendBtn = document.getElementById('resendBtn');
    const resendText = document.getElementById('resendText');
    const countdownEl = document.getElementById('countdown');
    
    let countdown = 60;
    let countdownInterval;
    
    // Auto-focus first input
    digitInputs[0].focus();
    
    // Handle digit input
    digitInputs.forEach((input, index) => {
        // Handle input
        input.addEventListener('input', function(e) {
            const value = e.target.value;
            
            // Only allow numbers
            if (!/^\d*$/.test(value)) {
                e.target.value = '';
                return;
            }
            
            // If a digit is entered, move to next input
            if (value.length === 1 && index < digitInputs.length - 1) {
                digitInputs[index + 1].focus();
            }
            
            // Update the hidden input
            updateHiddenInput();
            
            // Enable/disable submit button based on completion
            toggleSubmitButton();
        });
        
        // Handle backspace
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace') {
                // If current input is empty, move to previous input
                if (e.target.value === '' && index > 0) {
                    digitInputs[index - 1].focus();
                }
            }
            
            // Handle arrow keys
            if (e.key === 'ArrowLeft' && index > 0) {
                digitInputs[index - 1].focus();
                e.preventDefault();
            }
            
            if (e.key === 'ArrowRight' && index < digitInputs.length - 1) {
                digitInputs[index + 1].focus();
                e.preventDefault();
            }
        });
        
        // Handle paste
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text');
            
            if (/^\d{6}$/.test(pastedData)) {
                // Fill all inputs with pasted data
                for (let i = 0; i < digitInputs.length; i++) {
                    if (i < pastedData.length) {
                        digitInputs[i].value = pastedData[i];
                    }
                }
                
                // Focus last input
                digitInputs[digitInputs.length - 1].focus();
                
                // Update hidden input and enable submit
                updateHiddenInput();
                toggleSubmitButton();
            }
        });
    });
    
    // Update hidden input with combined digits
    function updateHiddenInput() {
        let code = '';
        digitInputs.forEach(input => {
            code += input.value;
        });
        hiddenInput.value = code;
    }
    
    // Toggle submit button state
    function toggleSubmitButton() {
        const code = hiddenInput.value;
        if (code.length === 6) {
            submitBtn.disabled = false;
        } else {
            submitBtn.disabled = true;
        }
    }
    
    // Form submission
    form.addEventListener('submit', function(e) {
        const code = hiddenInput.value;
        
        if (code.length !== 6) {
            e.preventDefault();
            // Highlight empty inputs
            digitInputs.forEach(input => {
                if (input.value === '') {
                    input.classList.add('border-red-500', 'bg-red-50');
                }
            });
            
            // Show error message
            alert('Harap masukkan kode 6 digit lengkap');
            return;
        }
        
        // Add loading state to button
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>Memverifikasi...';
    });
    
    // Resend code functionality
    resendBtn.addEventListener('click', function() {
        if (resendBtn.classList.contains('disabled')) return;
        
        // Start countdown
        startCountdown();
        
        // Simulate API call to resend code
        // In a real implementation, this would be an AJAX call to your backend
        setTimeout(() => {
            alert('Kode verifikasi baru telah dikirim ke WhatsApp Anda');
        }, 1000);
    });
    
    // Countdown for resend button
    function startCountdown() {
        resendBtn.classList.add('disabled');
        resendText.classList.add('hidden');
        countdownEl.classList.remove('hidden');
        countdownEl.textContent = `(${countdown})`;
        
        countdownInterval = setInterval(() => {
            countdown--;
            countdownEl.textContent = `(${countdown})`;
            
            if (countdown <= 0) {
                clearInterval(countdownInterval);
                resendBtn.classList.remove('disabled');
                resendText.classList.remove('hidden');
                countdownEl.classList.add('hidden');
                countdown = 60;
            }
        }, 1000);
    }
    
    // Initialize
    toggleSubmitButton();
});
</script>

<style>
.digit-input {
    transition: all 0.2s ease;
}

.digit-input:focus {
    transform: scale(1.05);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Animation for the shield icon */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.fa-shield-alt {
    animation: pulse 2s infinite;
}

/* Disabled state for resend button */
.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>
{% endblock %}